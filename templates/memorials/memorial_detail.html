{% extends 'base.html' %}
{% load static %}

{# ======================== TITLE BLOCK ======================== #}
{% block title %}{{ memorial.first_name }} {{ memorial.last_name }} - Memorial{% endblock %}

{# ======================== MAIN CONTENT BLOCK ======================== #}
{% block content %}
  {# ------------------------ Custom CSS ------------------------ #}
<link rel="stylesheet" href="{% static 'css/memorials/memorial_detail.css' %}">

  {# ------------------------ Flash Messages ------------------------ #}
  {% if messages %}
    <div class="container mt-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" 
             role="alert">
          {{ message }}
          <button type="button" 
                  class="btn-close" 
                  data-bs-dismiss="alert" 
                  aria-label="Close">
          </button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# ------------------------ Memorial Banner ------------------------ #}
  {% if memorial.banner_type == 'image' and memorial.banner_value %}
    <div id="memorialBanner" 
         class="banner banner-image"
         data-memorial-id="{{ memorial.pk }}"
         style="background-image: url('{% static memorial.banner_value %}');">
  {% elif memorial.banner_type == 'color' and memorial.banner_value %}
    <div id="memorialBanner" 
         class="banner banner-color"
         data-memorial-id="{{ memorial.pk }}"
         style="background-color: {{ memorial.banner_value }};">
  {% else %}
    <div id="memorialBanner" 
         class="banner banner-default"
         data-memorial-id="{{ memorial.pk }}">
  {% endif %}
    </div>

{# ------------------------ Profile Picture Section ------------------------ #}
  <div id="pfpUploadForm">
    <div class="profile-pic-wrapper upload-wrapper" 
         title="profile picture" 
         data-bs-toggle="modal" 
         data-bs-target="#profilePictureModal">
      {% if memorial.profile_public_id %}
        <img src="https://res.cloudinary.com/neverforgotten/image/upload/{{ memorial.profile_public_id }}.png?{% now 'U' %}" 
             alt="Profile Picture of {{ memorial.first_name }}" 
             class="profile-image-clickable"
             data-original-src="https://res.cloudinary.com/neverforgotten/image/upload/{{ memorial.profile_public_id }}.png">
      {% else %}
        <img src="{% static 'images/nf.png' %}" 
             alt="Default memorial image" 
             class="profile-image-clickable"
             data-original-src="{% static 'images/nf.png' %}">
      {% endif %}
    </div>
  </div>

  {# ------------------------ Profile Picture Modal ------------------------ #}
  <div class="modal fade" 
       id="profilePictureModal" 
       tabindex="-1" 
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 bg-transparent">
        <div class="modal-body text-center p-0">
          <button type="button" 
                  class="btn-close btn-close-white position-absolute top-0 end-0 m-2" 
                  data-bs-dismiss="modal" 
                  aria-label="Close">
          </button>
          {% if memorial.profile_public_id %}
            <img src="https://res.cloudinary.com/neverforgotten/image/upload/{{ memorial.profile_public_id }}.png" 
                 class="img-fluid rounded" 
                 alt="Enlarged profile picture of {{ memorial.first_name }}">
          {% else %}
            <img src="{% static 'images/nf.png' %}" 
                 class="img-fluid rounded" 
                 alt="Enlarged default memorial image">
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {# ------------------------ Name and Dates Section ------------------------ #}
  <div class="container text-center mt-0" style="bottom: 100px;">
    <h1 class="fw-bold">
      {{ memorial.first_name }} 
      {% if memorial.middle_name %}{{ memorial.middle_name }} {% endif %}
      {{ memorial.last_name }}
    </h1>
    <br>
    <p class="dates">
      {{ memorial.date_of_birth|date:"F j, Y" }} - {{ memorial.date_of_death|date:"F j, Y" }}
    </p>
  </div>

  {# ------------------------ Share Button ------------------------ #}
  <div class="d-flex justify-content-center my-4">
    <button id="shareButton" 
            class="btn btn-outline-primary share-button">
      <i class="fas fa-share-alt me-2"></i> Share Memorial Page
    </button>
  </div>

  {# ------------------------ Edit Button (for owner) ------------------------ #}
  {% if request.user == memorial.user %}
    <div class="d-flex justify-content-center mb-4">
      <a href="{% url 'memorials:memorial_edit' pk=memorial.pk %}" 
         class="view-btn btn btn-primary">
        <i class="fas fa-edit"></i> Edit Memorial
      </a>
    </div>
  {% endif %}

  {# ------------------------ Quote Section ------------------------ #}
  <div class="quote-container container text-center my-5">
    <blockquote class="memorial-quote">
      <div class="quote-content-wrapper">
        <i class="fas fa-quote-left quote-icon"></i>
        <p class="quote-text">
          {% if memorial.quote %}
            {{ memorial.quote }}
          {% else %}
            In Loving Memory of {{ memorial.first_name }}
          {% endif %}
        </p>
        <i class="fas fa-quote-right quote-icon"></i>
      </div>
      {% if memorial.quote_author %}
        <footer class="blockquote-footer mt-3">
          <cite>{{ memorial.quote_author }}</cite>
        </footer>
      {% endif %}
    </blockquote>
  </div>

  {# ------------------------ Biography Section ------------------------ #}
  <div class="biography-container container text-left mt-4">
    <h2 class="biography-title">Remembering {{ memorial.first_name }}</h2>
    <div class="biography-divider"></div>
    <div class="mt-3 biography-text">
      {% if memorial.biography %}
        {{ memorial.biography|linebreaksbr }}
      {% else %}
        <p class="biography-placeholder">
          <i class="far fa-heart"></i>
          {{ memorial.first_name }}'s life story has not been shared yet.
        </p>
      {% endif %}
    </div>
  </div>

  {# ======================== TRIBUTES SECTION ======================== #}
  <section class="tributes-section container mt-5 p-4 rounded-3 shadow-sm bg-light" 
           data-memorial-id="{{ memorial.pk }}"
           data-delete-tribute-url="{% url 'memorials:delete_tribute' 0 %}">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="section-title fs-3 fw-bold text-dark">Tributes</h2>
      <button id="open-tribute-form" 
              class="btn btn-primary rounded-pill px-3" 
              data-bs-toggle="modal" 
              data-bs-target="#tributeFormModal"
              aria-label="Create new tribute">
        <i class="fas fa-plus me-2"></i>Create Tribute
      </button>
    </div>

    {# ------------------------ Tribute Form Modal ------------------------ #}
    <div class="modal fade" 
         id="tributeFormModal" 
         tabindex="-1" 
         aria-labelledby="tributeFormModalLabel" 
         aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-light">
            <h3 class="modal-title fs-5" id="tributeFormModalLabel">Share Your Tribute</h3>
            <button type="button" 
                    class="btn-close" 
                    data-bs-dismiss="modal" 
                    aria-label="Close">
            </button>
          </div>
          <div class="modal-body">
            <form id="tribute-form" 
                  method="POST" 
                  action="{% url 'memorials:create_tribute' memorial.pk %}">
              {% csrf_token %}
              <div class="mb-3">
                <label for="author_name" class="form-label fw-semibold">Your Name</label>
                <input type="text" 
                       class="form-control py-2" 
                       id="author_name" 
                       name="author_name" 
                       required
                       placeholder="Enter your name" 
                       value="{% if user.is_authenticated %}{{ user.first_name }}{% endif %}">
              </div>
              <div class="mb-4">
                <label for="message" class="form-label fw-semibold">Your Tribute</label>
                <textarea class="form-control py-2" 
                          id="message" 
                          name="message" 
                          rows="5" 
                          required
                          placeholder="Share your memories, thoughts, or condolences...">
                </textarea>
                <div class="form-text">
                  Your tribute will be visible to all visitors of this memorial.
                </div>
              </div>
              <div class="d-flex justify-content-end gap-3">
                <button type="button" 
                        class="btn btn-outline-secondary px-4" 
                        data-bs-dismiss="modal">
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary px-4">Post Tribute</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    {# ------------------------ Tribute List ------------------------ #}
    <div id="tribute-list" class="row g-4">
      {# Visible tributes (first 3) #}
      <div id="visible-tributes">
        {% for tribute in memorial.tributes.all|slice:":3" %}
          <div class="col-12 tribute-item" data-tribute-id="{{ tribute.id }}">
            <div class="card tribute-card h-100 border-0 shadow-sm">
              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h3 class="card-title mb-0 fs-5 fw-semibold">{{ tribute.author_name }}</h3>
                  <small class="text-muted">{{ tribute.created_at|date:"M j, Y" }}</small>
                </div>
                <div class="card-text flex-grow-1 mb-3 lh-base tribute-message">
                  {{ tribute.message|linebreaksbr }}
                </div>
                {% if request.user == memorial.user or request.user == tribute.user %}
                  <div class="mt-auto text-end" data-user-can-edit="true">
                    <button class="btn btn-sm btn-outline-primary edit-tribute me-2" 
                            data-tribute-id="{{ tribute.id }}"
                            data-author-name="{{ tribute.author_name }}"
                            data-message="{{ tribute.message }}"
                            aria-label="Edit tribute">
                      <i class="fas fa-edit me-1"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-tribute" 
                            data-tribute-id="{{ tribute.id }}"
                            aria-label="Delete tribute">
                      <i class="fas fa-trash me-1"></i> Delete
                    </button>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% empty %}
          <div class="col-12" id="empty-tributes-message">
            <div class="empty-tributes text-center py-5">
              <i class="fas fa-heart text-muted fa-4x mb-4"></i>
              <h3 class="h5 text-muted mb-3">No tributes yet</h3>
              <p class="text-muted mb-4">
                Be the first to share your memories of {{ memorial.first_name }}
              </p>
            </div>
          </div>
        {% endfor %}
      </div>

      {# Hidden additional tributes #}
      <div id="hidden-tributes" class="row g-4 d-none">
        {% for tribute in memorial.tributes.all|slice:"3:" %}
          <div class="col-12 tribute-item tribute-special" data-tribute-id="{{ tribute.id }}">
            <div class="card tribute-card h-100 border-0 shadow-sm">
              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h3 class="card-title mb-0 fs-5 fw-semibold">{{ tribute.author_name }}</h3>
                  <small class="text-muted">{{ tribute.created_at|date:"M j, Y" }}</small>
                </div>
                <div class="card-text flex-grow-1 mb-3 lh-base tribute-message">
                  {{ tribute.message|linebreaksbr }}
                </div>
                {% if request.user == memorial.user or request.user == tribute.user %}
                  <div class="mt-auto text-end" data-user-can-edit="true">
                    <button class="btn btn-sm btn-outline-primary edit-tribute me-2" 
                            data-tribute-id="{{ tribute.id }}"
                            data-author-name="{{ tribute.author_name }}"
                            data-message="{{ tribute.message }}"
                            aria-label="Edit tribute">
                      <i class="fas fa-edit me-1"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-tribute" 
                            data-tribute-id="{{ tribute.id }}"
                            aria-label="Delete tribute">
                      <i class="fas fa-trash me-1"></i> Delete
                    </button>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    {# View All Tributes Button #}
    {% if memorial.tributes.count > 3 %}
      <div class="text-center mt-4">
        <button id="toggle-tributes-btn" class="btn btn-secondary rounded-pill px-4">
          <i class="fas fa-chevron-down me-2"></i>View All Tributes
        </button>
      </div>
    {% endif %}
  </section>

  {# ------------------------ Edit Tribute Modal ------------------------ #}
  <div class="modal fade" 
       id="editTributeModal" 
       tabindex="-1" 
       aria-labelledby="editTributeModalLabel" 
       aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h3 class="modal-title fs-5" id="editTributeModalLabel">Edit Tribute</h3>
          <button type="button" 
                  class="btn-close" 
                  data-bs-dismiss="modal" 
                  aria-label="Close">
          </button>
        </div>
        <div class="modal-body">
          <form id="edit-tribute-form" method="POST">
            {% csrf_token %}
            <input type="hidden" id="edit-tribute-id" name="tribute_id">
            <div class="mb-3">
              <label for="edit-author-name" class="form-label fw-semibold">Your Name</label>
              <input type="text" 
                     class="form-control py-2" 
                     id="edit-author-name" 
                     name="author_name" 
                     required>
            </div>
            <div class="mb-4">
              <label for="edit-message" class="form-label fw-semibold">Your Tribute</label>
              <textarea class="form-control py-2" 
                        id="edit-message" 
                        name="message" 
                        rows="5" 
                        required>
              </textarea>
            </div>
            <div class="d-flex justify-content-end gap-3">
              <button type="button" 
                      class="btn btn-outline-secondary px-4" 
                      data-bs-dismiss="modal">
                Cancel
              </button>
              <button type="submit" class="btn btn-primary px-4">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  {# ------------------------ Delete Tribute Modal ------------------------ #}
  <div class="modal fade" 
       id="deleteTributeModal" 
       tabindex="-1" 
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h3 class="modal-title fs-5">Confirm Deletion</h3>
          <button type="button" 
                  class="btn-close" 
                  data-bs-dismiss="modal" 
                  aria-label="Close">
          </button>
        </div>
        <div class="modal-body py-4">
          <p class="mb-2">Are you sure you want to delete this tribute?</p>
          <div class="alert alert-light mt-3">
            <strong id="delete-tribute-author"></strong>
            <p id="delete-tribute-message" class="mb-0"></p>
          </div>
          <p class="text-danger mt-3">This action cannot be undone.</p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" 
                  class="btn btn-outline-secondary" 
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" id="confirm-delete" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>


{% endblock %}

{% block extra_js %}
<script>
/**
 * Main memorial page functionality including tributes, stories, sharing and gallery.
 * All code runs after DOM is fully loaded.
 */
document.addEventListener('DOMContentLoaded', () => {
  // ------------------------- TRIBUTES FUNCTIONALITY -------------------------
  const tributesSection = document.querySelector('.tributes-section');
  
  if (tributesSection) {
    const memorialId = tributesSection.dataset.memorialId;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    // Initialize Bootstrap modals
    const tributeFormModal = bootstrap.Modal.getOrCreateInstance(
      document.getElementById('tributeFormModal')
    );
    const editTributeModal = bootstrap.Modal.getOrCreateInstance(
      document.getElementById('editTributeModal')
    );

    // Cache DOM elements
    const tributeList = document.getElementById('tribute-list');
    const openTributeFormBtn = document.getElementById('open-tribute-form');
    const tributeForm = document.getElementById('tribute-form');
    const editTributeForm = document.getElementById('edit-tribute-form');

    /**
     * Escapes HTML to prevent XSS attacks
     * @param {string} str - Input string to escape
     * @return {string} Escaped HTML string
     */
    function escapeHTML(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    /**
     * Generates HTML for a tribute card
     * @param {Object} tribute - Tribute data object
     * @param {boolean} canEdit - Whether user can edit this tribute
     * @return {string} HTML string for the tribute card
     */
    function generateTributeCard(tribute, canEdit = false) {
      const dateStr = new Date(tribute.created_at).toLocaleDateString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });

      return `
        <div class="col-12 tribute-item" data-tribute-id="${tribute.id}">
          <div class="card tribute-card h-100 border-0 shadow-sm">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h3 class="card-title mb-0 fs-5 fw-semibold">${escapeHTML(tribute.author_name)}</h3>
                <small class="text-muted">${dateStr}</small>
              </div>
              <div class="card-text flex-grow-1 mb-3 lh-base tribute-message">
                ${escapeHTML(tribute.message).replace(/\n/g, '<br>')}
              </div>
              ${canEdit ? `
              <div class="mt-auto text-end" data-user-can-edit="true">
                <button class="btn btn-sm btn-outline-primary edit-tribute me-2" 
                        data-tribute-id="${tribute.id}"
                        data-author-name="${escapeHTML(tribute.author_name)}"
                        data-message="${escapeHTML(tribute.message)}"
                        aria-label="Edit tribute">
                  <i class="fas fa-edit me-1"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger delete-tribute" 
                        data-tribute-id="${tribute.id}"
                        aria-label="Delete tribute">
                  <i class="fas fa-trash me-1"></i> Delete
                </button>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // Event Listeners
    if (openTributeFormBtn) {
      openTributeFormBtn.addEventListener('click', () => {
        tributeForm.reset();
        tributeForm.action = `/memorials/${memorialId}/tributes/create/`;
        tributeFormModal.show();
      });
    }

    if (tributeForm) {
      tributeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(tributeForm);

        try {
          const response = await fetch(tributeForm.action, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            const emptyMessage = document.getElementById('empty-tributes-message');
            if (emptyMessage) emptyMessage.remove();

            tributeList.insertAdjacentHTML('afterbegin', 
              generateTributeCard(data.tribute, data.can_edit));
            tributeFormModal.hide();
            tributeForm.reset();
          } else {
            throw new Error(data.error || 'Failed to create tribute');
          }
        } catch (error) {
          console.error('Error:', error);
          alert(`Error: ${error.message}`);
        }
      });
    }

    if (tributeList) {
      tributeList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-tribute');
        const deleteBtn = e.target.closest('.delete-tribute');

        if (editBtn) {
          editTributeForm.action = `/memorials/tributes/${editBtn.dataset.tributeId}/edit/`;
          document.getElementById('edit-tribute-id').value = editBtn.dataset.tributeId;
          document.getElementById('edit-author-name').value = editBtn.dataset.authorName;
          document.getElementById('edit-message').value = editBtn.dataset.message;
          editTributeModal.show();
        } else if (deleteBtn) {
          if (confirm('Are you sure you want to delete this tribute?')) {
            deleteTribute(deleteBtn.dataset.tributeId);
          }
        }
      });
    }

    if (editTributeForm) {
      editTributeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(editTributeForm);
        const tributeId = formData.get('tribute_id');

        try {
          const response = await fetch(editTributeForm.action, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            const tributeElem = document.querySelector(
              `.tribute-item[data-tribute-id="${tributeId}"]`
            );
            if (tributeElem) {
              tributeElem.outerHTML = generateTributeCard(data.tribute, data.can_edit);
            }
            editTributeModal.hide();
          } else {
            throw new Error(data.error || 'Failed to update tribute');
          }
        } catch (error) {
          console.error('Error:', error);
          alert(`Error: ${error.message}`);
        }
      });
    }

    /**
     * Deletes a tribute via AJAX
     * @param {string} tributeId - ID of the tribute to delete
     */
    async function deleteTribute(tributeId) {
      try {
        const response = await fetch(`/memorials/tributes/${tributeId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
          },
        });

        const data = await response.json();

        if (data.success) {
          const tributeElem = document.querySelector(
            `.tribute-item[data-tribute-id="${tributeId}"]`
          );
          tributeElem?.remove();
          
          if (!document.querySelector('.tribute-item')) {
            document.getElementById('empty-tributes-message')?.classList.remove('d-none');
          }
        } else {
          throw new Error(data.error || 'Failed to delete tribute');
        }
      } catch (error) {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
      }
    }

    // Toggle tributes visibility
    const toggleTributesBtn = document.getElementById('toggle-tributes-btn');
    const hiddenTributes = document.getElementById('hidden-tributes');
    
    if (toggleTributesBtn && hiddenTributes) {
      toggleTributesBtn.addEventListener('click', function() {
        hiddenTributes.classList.toggle('d-none');
        this.innerHTML = hiddenTributes.classList.contains('d-none') 
          ? '<i class="fas fa-chevron-down me-2"></i>View More'
          : '<i class="fas fa-chevron-up me-2"></i>View Less';
      });
    }
  }
</scripts>
{% endblock %}